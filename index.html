<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±†åŒ…é€šè¯ - å¼ºåˆ¶å¯åŠ¨ç‰ˆ</title>
    <!-- ä½¿ç”¨æœ¬åœ° SDK -->
    <script src="volcengine-rtc-sdk.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #local-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #debug-log { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #0f0; padding: 12px; font-size: 11px; z-index: 1000; border-radius: 8px; max-height: 120px; overflow-y: auto; pointer-events: none; white-space: pre-wrap; }
        .bottom-overlay { position: absolute; bottom: 180px; left: 0; width: 100%; padding: 0 20px; z-index: 50; box-sizing: border-box; }
        .ai-msg-box { background: rgba(0,0,0,0.7); padding: 15px; border-radius: 12px; color: #fff; font-size: 18px; border: 1px solid rgba(255,255,255,0.2); }
        .controls { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 999; }
        .talk-btn { width: 90px; height: 90px; background: #7d60f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid #fff; transition: all 0.2s; cursor: pointer; box-shadow: 0 0 20px rgba(125,96,245,0.5); }
        .talk-btn.active { background: #ff4d4f; transform: scale(1.1); }
        #start-mask { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .start-btn { background: #7d60f5; color: #fff; border: none; padding: 18px 50px; border-radius: 35px; font-size: 20px; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div id="debug-log">ç³»ç»Ÿæ—¥å¿—: ç­‰å¾…ç‚¹å‡»å¯åŠ¨</div>
    <video id="local-video" autoplay playsinline muted></video>
    <div id="remote-audio-player" style="display:none"></div>

    <div class="bottom-overlay">
        <div class="ai-msg-box">
            <span style="color:#9c8fff;font-weight:bold">è±†åŒ…:</span> <span id="ai-text">è¯·å¼€å¯é€šè¯...</span>
        </div>
    </div>

    <div class="controls" id="controls-ui" style="display:none;">
        <button class="talk-btn" id="talk-trigger" onclick="handleTalk()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></svg>
        </button>
        <p style="color:white;margin-top:10px;font-size:14px;font-weight:bold">ç‚¹å‡»ç´«è‰²æŒ‰é’®è¯´è¯</p>
    </div>

    <div id="start-mask">
        <button class="start-btn" id="real-start-btn">å¼€å¯è±†åŒ…è§†é¢‘é€šè¯</button>
        <div id="sdk-status" style="color:#666;font-size:12px">æ­£åœ¨æ£€æµ‹æ’ä»¶...</div>
    </div>

    <script>
        const CONFIG = {
            appId: "694e817400efda0175310f9e", 
            roomId: "marcelroom",
            userId: "marceluser",
            token: "001694e817400efda0175310f9eSgCWU98FmrdOaRryV2kKAG1hcmNlbHJvb20KAG1hcmNlbHVzZXIGAAAAGvJXaQEAGvJXaQIAGvJXaQMAGvJXaQQAGvJXaQUAGvJXaSAAC94o5eNHsT4oSzS5/CFy5ZM3HBe9pDCB4bXKGGSkF+g="
        };

        let rtc, isRecording = false;
        function log(msg) { 
            const d = document.getElementById('debug-log');
            d.innerText += `\n> ${msg}`; 
            d.scrollTop = d.scrollHeight;
        }

        // 1. è‡ªåŠ¨æ£€æµ‹ SDK æ˜¯å¦åŠ è½½
        setInterval(() => {
            const sdk = window.VolcEngineRTC || window.VERTC;
            const status = document.getElementById('sdk-status');
            if (sdk) {
                status.innerText = "âœ… æ’ä»¶åŠ è½½æˆåŠŸ (v" + (sdk.VERSION || "4.x") + ")";
                status.style.color = "#52c41a";
            }
        }, 1000);

        // 2. ç»‘å®šå¯åŠ¨æŒ‰é’®
        document.getElementById('real-start-btn').addEventListener('click', function() {
            log("æ”¶åˆ°ç‚¹å‡»ï¼Œå°è¯•å¼ºè¡Œå¯åŠ¨...");
            document.getElementById('start-mask').style.display = 'none'; // å¼ºè¡Œå…³é—­é®ç½©
            document.getElementById('controls-ui').style.display = 'flex';
            initCall();
        });

        async function initCall() {
            const sdk = window.VolcEngineRTC || window.VERTC;
            if (!sdk) {
                log("âŒ å¯åŠ¨ä¸­æ–­ï¼šSDKæ’ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°ç½‘é¡µ");
                return;
            }

            try {
                log("ğŸ‘‰ æ­¥éª¤ Aï¼šåˆ›å»ºå¼•æ“");
                rtc = sdk.createEngine(CONFIG.appId);
                
                rtc.on('onUserJoined', () => { 
                    log("âœ… è±†åŒ…å·²è¿›æˆ¿ï¼"); 
                    document.getElementById('ai-text').innerText = "è±†åŒ…ä¸Šçº¿äº†ï¼Œè·Ÿæˆ‘è¯´è¯å§";
                });
                
                rtc.on('onUserPublishStream', async (uid, type) => {
                    if (type === sdk.MediaType.AUDIO) {
                        log("æ¥æ”¶ AI å£°éŸ³...");
                        const { player } = await rtc.subscribeStream(uid, sdk.MediaType.AUDIO);
                        player.play('remote-audio-player');
                    }
                });

                rtc.on('onStreamMessageReceived', (uid, sid, msg) => {
                    document.getElementById('ai-text').innerText = new TextDecoder().decode(msg);
                });

                log("ğŸ‘‰ æ­¥éª¤ Bï¼šè¯·æ±‚æ‘„åƒå¤´ (è‹¥æ— ååº”è¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®)");
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = stream;
                log("âœ… æ‘„åƒå¤´å¼€å¯æˆåŠŸ");

                log("ğŸ‘‰ æ­¥éª¤ Cï¼šæ‰§è¡Œè¿›æˆ¿ (TokenéªŒè¯)");
                await rtc.joinRoom(CONFIG.token, CONFIG.roomId, { userId: CONFIG.userId });
                log("âœ… è¿›æˆ¿æˆåŠŸï¼");
                
                log("ğŸ‘‰ æ­¥éª¤ Dï¼šå‘å¸ƒè§†é¢‘æµ");
                await rtc.publishStream(sdk.MediaType.AUDIO_AND_VIDEO);
                rtc.muteLocalAudioStream(true); 
                log("ğŸ‰ æ‰‹æœºç«¯å·²å°±ç»ªï¼å¯ä»¥è¿è¡Œ Mac è„šæœ¬äº†");

            } catch (e) {
                log("âŒ å¤±è´¥åŸå› : " + e.message);
                alert("å…·ä½“æŠ¥é”™: " + e.message);
            }
        }

        function handleTalk() {
            if (!rtc) return;
            isRecording = !isRecording;
            rtc.muteLocalAudioStream(!isRecording);
            const btn = document.getElementById('talk-trigger');
            btn.classList.toggle('active', isRecording);
            document.getElementById('ai-text').innerText = isRecording ? "æ­£åœ¨å¬ä½ è¯´..." : "è±†åŒ…æ­£åœ¨è§‚å¯Ÿç”»é¢...";
            log(isRecording ? "ğŸ¤ éº¦å…‹é£å·²å¼€" : "ğŸ”‡ éº¦å…‹é£å·²å…³");
        }
    </script>
</body>
</html>
