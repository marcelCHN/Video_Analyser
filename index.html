<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±†åŒ…é€šè¯-å…¨æµç¨‹ç›‘æ§ç‰ˆ</title>
    <script src="volcengine-rtc-sdk.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #local-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        /* é¡¶éƒ¨çŠ¶æ€ç›‘æ§ - å¢åŠ èƒŒæ™¯è‰²ä½¿å…¶æ¸…æ™° */
        #debug-log { 
            position: absolute; top: 10px; left: 10px; right: 10px; 
            background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; 
            font-size: 12px; z-index: 1000; border-radius: 5px; line-height: 1.4;
        }

        .bottom-overlay { position: absolute; bottom: 160px; left: 0; width: 100%; padding: 0 20px; z-index: 50; box-sizing: border-box; }
        .ai-msg-box { background: rgba(0,0,0,0.7); padding: 15px; border-radius: 12px; color: #fff; font-size: 18px; border: 1px solid rgba(255,255,255,0.2); }
        
        .controls { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 999; }
        .talk-btn { 
            width: 90px; height: 90px; background: #7d60f5; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            border: 4px solid #fff; transition: all 0.2s; cursor: pointer;
        }
        .talk-btn.recording { background: #ff4d4f; box-shadow: 0 0 30px #ff4d4f; transform: scale(1.1); }
        .talk-hint { color: #fff; margin-top: 10px; font-size: 14px; font-weight: bold; }

        #start-mask { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .start-btn { background: #7d60f5; color: #fff; border: none; padding: 18px 50px; border-radius: 35px; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <!-- å®æ—¶çŠ¶æ€ç›‘æ§åŒº -->
    <div id="debug-log">ç­‰å¾…ç‚¹å‡»â€œå¼€å¯é€šè¯â€...</div>

    <video id="local-video" autoplay playsinline muted></video>
    <div id="remote-player" style="display:none"></div>

    <div class="bottom-overlay">
        <div class="ai-msg-box">
            <span style="color:#9c8fff;font-weight:bold">è±†åŒ…:</span>
            <span id="ai-text">è¯·æŒ‰æ­¥éª¤å®Œæˆåˆå§‹åŒ–...</span>
        </div>
    </div>

    <div class="controls" id="controls-ui" style="display:none;">
        <button class="talk-btn" id="talk-trigger" onclick="toggleMic()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></svg>
        </button>
        <div class="talk-hint" id="talk-hint">ç‚¹å‡»è¯´è¯</div>
    </div>

    <div id="start-mask"><button class="start-btn" onclick="initCall()">å¼€å¯é€šè¯</button></div>

    <script>
        const CONFIG = {
            appId: "694e815bd68e9101747f2d3b",
            roomId: "marcel20251226",
            userId: "marcel20251226",
            token: "001694e817400efda0175310f9eUgDDdakEI6tOaaPlV2kOAG1hcmNlbDIwMjUxMjI2DgBtYXJjZWwyMDI1MTIyNgYAAACj5VdpAQCj5VdpAgCj5VdpAwCj5VdpBACj5VdpBQCj5VdpIADRJtiITM1y5CZgKy0aEAhHtqzEcj9fuAH9G8IygZUzHQ=="
        };

        let rtc, isRecording = false;

        // å¢å¼ºç‰ˆæ—¥å¿—æ‰“å°
        function log(msg) {
            const div = document.getElementById('debug-log');
            const now = new Date().toLocaleTimeString();
            div.innerHTML += `<br>[${now}] ${msg}`;
            console.log(msg);
        }

        async function initCall() {
            log("ğŸ‘‰ 1. æ£€æµ‹ SDK å˜é‡...");
            const sdk = window.VolcEngineRTC || window.VERTC;
            if (!sdk) {
                log("âŒ SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ volcengine-rtc-sdk.js æ˜¯å¦åœ¨ä»“åº“æ ¹ç›®å½•ã€‚");
                return;
            }

            document.getElementById('start-mask').style.display = 'none';
            document.getElementById('controls-ui').style.display = 'flex';

            try {
                log("ğŸ‘‰ 2. æ­£åœ¨åˆ›å»ºå¼•æ“...");
                rtc = sdk.createEngine(CONFIG.appId);
                
                // ç›‘å¬ AI åŠ å…¥
                rtc.on('onUserJoined', () => {
                    log("âœ… æˆåŠŸï¼šç›‘å¬åˆ° AI è¿›æˆ¿ï¼");
                    document.getElementById('ai-text').innerText = "è±†åŒ…å·²ä¸Šçº¿ï¼Œç‚¹å‡»ç´«è‰²æŒ‰é’®å¼€å§‹èŠå¤©";
                });

                rtc.on('onStreamMessageReceived', (uid, sid, msg) => {
                    document.getElementById('ai-text').innerText = new TextDecoder().decode(msg);
                });

                log("ğŸ‘‰ 3. æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™ (è¯·ç‚¹å‡»å…è®¸)...");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = stream;
                log("âœ… æ‘„åƒå¤´æƒé™è·å–æˆåŠŸ");

                log("ğŸ‘‰ 4. æ­£åœ¨åŠ å…¥æˆ¿é—´...");
                await rtc.joinRoom(CONFIG.token, CONFIG.roomId, { userId: CONFIG.userId });
                log("âœ… æˆåŠŸåŠ å…¥æˆ¿é—´");

                log("ğŸ‘‰ 5. æ­£åœ¨å‘å¸ƒè§†é¢‘æµ...");
                await rtc.publishStream(sdk.MediaType.AUDIO_AND_VIDEO);
                
                rtc.muteLocalAudioStream(true);
                log("ğŸ‰ æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼è¯·å¯åŠ¨ Python è„šæœ¬ã€‚");

            } catch (e) {
                log("âŒ æŠ¥é”™: " + e.message);
                alert("å…·ä½“é”™è¯¯: " + e.message);
            }
        }

        function toggleMic() {
            if (!rtc) { log("é”™è¯¯ï¼šå¼•æ“æœªåˆå§‹åŒ–"); return; }
            const btn = document.getElementById('talk-trigger');
            const hint = document.getElementById('talk-hint');
            if (!isRecording) {
                rtc.muteLocalAudioStream(false);
                btn.classList.add('recording');
                hint.innerText = "æ­£åœ¨å¬...ç‚¹æˆ‘åœæ­¢";
                isRecording = true;
                log("ğŸ¤ éº¦å…‹é£å·²å¼€å¯");
            } else {
                rtc.muteLocalAudioStream(true);
                btn.classList.remove('recording');
                hint.innerText = "ç‚¹å‡»è¯´è¯";
                isRecording = false;
                log("ğŸ”‡ éº¦å…‹é£å·²å…³é—­");
            }
        }
    </script>
</body>
</html>
