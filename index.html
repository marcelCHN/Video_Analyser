<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±†åŒ…é€šè¯-è‡ªé€‚åº”è½®å·¡ç‰ˆ</title>
    <script src="volcengine-rtc-sdk.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #local-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #debug-log { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.85); color: #0f0; padding: 12px; font-size: 11px; z-index: 1000; border-radius: 8px; max-height: 180px; overflow-y: auto; border: 1px solid #444; line-height: 1.6; }
        .bottom-overlay { position: absolute; bottom: 180px; left: 0; width: 100%; padding: 0 20px; z-index: 50; box-sizing: border-box; }
        .ai-msg-box { background: rgba(0,0,0,0.75); padding: 15px; border-radius: 12px; color: #fff; font-size: 18px; border: 1px solid rgba(255,255,255,0.2); }
        .controls { position: absolute; bottom: 40px; left: 0; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 999; }
        .talk-btn { width: 90px; height: 90px; background: #7d60f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid #fff; transition: all 0.2s; cursor: pointer; }
        .talk-btn.active { background: #ff4d4f; box-shadow: 0 0 30px #ff4d4f; }
        #start-mask { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .start-btn { background: #7d60f5; color: #fff; border: none; padding: 18px 50px; border-radius: 35px; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="debug-log">ğŸš€ å¤šå¥—é…ç½®è‡ªé€‚åº”å¯åŠ¨æ¨¡å¼...</div>
    <video id="local-video" autoplay playsinline muted></video>
    <div id="remote-audio" style="display:none"></div>

    <div class="bottom-overlay">
        <div class="ai-msg-box">
            <span style="color:#9c8fff;font-weight:bold">è±†åŒ…:</span> <span id="ai-text">æ­£åœ¨è‡ªåŠ¨å°è¯•æœ€ä½³é…ç½®...</span>
        </div>
    </div>

    <div class="controls" id="controls-ui" style="display:none;">
        <button class="talk-btn" id="talk-trigger" onclick="toggleTalk()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zM17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></svg>
        </button>
        <p id="talk-hint" style="color:white;margin-top:10px;font-size:14px;font-weight:bold">ç‚¹å‡»è¯´è¯</p>
    </div>

    <div id="start-mask"><button class="start-btn" onclick="runAdaptiveInit()">å¼€å¯å…¨è‡ªåŠ¨è”è°ƒ</button></div>

    <script>
        // é…ç½®çŸ©é˜µï¼šå¦‚æœç¬¬ä¸€å¥—ä¸è¡Œï¼Œè‡ªåŠ¨æ¢ç¬¬äºŒå¥—
        const CONFIG_MATRIX = [
            {
                name: "æ–¹æ¡ˆ A (d3bé¡¹ç›®)",
                appId: "694e815bd68e9101747f2d3b",
                roomId: "marcel20251227",
                userId: "marcel20251227",
                token: "001694e815bd68e9101747f2d3bUgCHHWoF/bJOaX3tV2kOAG1hcmNlbDIwMjUxMjI3DgBtYXJjZWwyMDI1MTIyNwYAAAB97VdpAQB97VdpAgB97VdpAwB97VdpBAB97VdpBQB97VdpIADZIoA9w+XZ1o1GXJ4JC4lyo3axb22ov4oDlm4ZGZ3NRg=="
            },
            {
                name: "æ–¹æ¡ˆ B (f9eé¡¹ç›®)",
                appId: "694e817400efda0175310f9e",
                roomId: "marcelroom",
                userId: "marceluser",
                token: "001694e817400efda0175310f9eSgCWU98FmrdOaRryV2kKAG1hcmNlbHJvb20KAG1hcmNlbHVzZXIGAAAAGvJXaQEAGvJXaQIAGvJXaQMAGvJXaQQAGvJXaQUAGvJXaSAAC94o5eNHsT4oSzS5/CFy5ZM3HBe9pDCB4bXKGGSkF+g="
            }
        ];

        let rtcEngine, currentConfigIndex = 0, isTalking = false;
        function log(msg, color="#0f0") { 
            const d = document.getElementById('debug-log');
            d.innerHTML += `<br><span style="color:${color}">> ${msg}</span>`; 
            d.scrollTop = d.scrollHeight;
        }

        async function runAdaptiveInit() {
            document.getElementById('start-mask').style.display = 'none';
            document.getElementById('controls-ui').style.display = 'flex';
            
            // 0. å…ˆå¼€æ‘„åƒå¤´
            try {
                log("æ­£åœ¨å¼€å¯é¢„è§ˆ...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('local-video').srcObject = stream;
            } catch(e) { log("âŒ æ‘„åƒå¤´å¤±è´¥: " + e.message, "red"); }

            tryConfig(0);
        }

        async function tryConfig(index) {
            if (index >= CONFIG_MATRIX.length) {
                log("âŒ æ‰€æœ‰é…ç½®å‡å°è¯•å¤±è´¥ï¼è¯·æ£€æŸ¥æ§åˆ¶å° AppID æ˜¯å¦å·²åœç”¨ã€‚", "red");
                alert("å…¨éƒ¨å¤±è´¥ï¼è¯·ç¡®è®¤ç«å±±å¼•æ“æ§åˆ¶å°æœåŠ¡çŠ¶æ€ã€‚");
                return;
            }

            const conf = CONFIG_MATRIX[index];
            currentConfigIndex = index;
            log(`å°è¯•ã€${conf.name}ã€‘...`, "yellow");

            const sdk = window.VolcEngineRTC || window.VERTC;
            if(rtcEngine) { try { sdk.destroyEngine(rtcEngine); } catch(e){} }
            
            rtcEngine = sdk.createEngine(conf.appId);
            
            // è®¾ç½®ç›‘å¬
            rtcEngine.on('onUserJoined', () => { 
                log(`âœ… é€šé“å·²å»ºç«‹ï¼AI è¿›æˆ¿æˆåŠŸ`, "#0f0");
                document.getElementById('ai-text').innerText = "è±†åŒ…å·²ä¸Šçº¿ï¼Œç‚¹ç´«è‰²æŒ‰é’®èŠå¤©";
            });
            rtcEngine.on('onStreamMessageReceived', (uid, sid, msg) => {
                document.getElementById('ai-text').innerText = new TextDecoder().decode(msg);
            });
            rtcEngine.on('onUserPublishStream', async (uid, type) => {
                if (type === sdk.MediaType.AUDIO) {
                    const { player } = await rtcEngine.subscribeStream(uid, sdk.MediaType.AUDIO);
                    player.play('remote-audio');
                }
            });

            // æ ¸å¿ƒï¼šå¸¦è¶…æ—¶çš„è¿›æˆ¿å°è¯•
            let hasTimedOut = false;
            const timer = setTimeout(() => {
                hasTimedOut = true;
                log(`âš ï¸ ${conf.name} è¿›æˆ¿è¶…æ—¶ï¼Œæ­£åœ¨åˆ‡æ¢ä¸‹ä¸ªæ–¹æ¡ˆ...`, "orange");
                tryConfig(index + 1);
            }, 6000);

            try {
                await rtcEngine.joinRoom(conf.token, conf.roomId, { userId: conf.userId });
                if(hasTimedOut) return;
                clearTimeout(timer);
                
                await rtcEngine.publishStream(sdk.MediaType.AUDIO_AND_VIDEO);
                rtcEngine.muteLocalAudioStream(true);
                log(`ğŸ‰ ${conf.name} è¿›æˆ¿æˆåŠŸï¼è¯·å¯åŠ¨ Mac ä¸Šçš„ Pythonã€‚`, "#0f0");
                document.getElementById('ai-text').innerText = "è¿æ¥æˆåŠŸï¼è¯·å»ç”µè„‘ä¸Šè¿è¡Œ Python";
            } catch (err) {
                if(hasTimedOut) return;
                clearTimeout(timer);
                log(`âŒ ${conf.name} æŠ¥é”™: ${err.message}`, "red");
                tryConfig(index + 1);
            }
        }

        function toggleTalk() {
            if (!rtcEngine) return;
            isTalking = !isTalking;
            rtcEngine.muteLocalAudioStream(!isTalking);
            document.getElementById('talk-trigger').classList.toggle('active', isTalking);
            document.getElementById('talk-hint').innerText = isTalking ? "æ­£åœ¨å¬..." : "ç‚¹å‡»è¯´è¯";
            log(isTalking ? "ğŸ¤ éº¦å…‹é£å·²å¼€å¯" : "ğŸ”‡ éº¦å…‹é£å·²å…³é—­");
        }
    </script>
</body>
</html>
